# Auth 도메인 시스템 개선 진행 현황

## 📊 전체 진행률

**현재 진행률: 7/9 (78%) ⬆️ + 핵심 아키텍처 리팩토링 완료**

---

## ✅ 완료된 과제들

### ★ 핵심 아키텍처 리팩토링: Service/DAO 레이어 분리 ✅

**왜 진행했는가?**
- 기존에는 서비스 로직이 직접 데이터베이스(Prisma)를 호출하여 비즈니스 로직과 데이터 접근 로직이 강하게 결합되어 있었습니다.
- 이로 인해 코드의 테스트가 어렵고, 의존성 관리가 복잡하며, 유지보수성이 저하되는 문제가 있었습니다.
- Spring Boot 스타일의 인터페이스 기반 아키텍처를 도입하여 문제를 해결하고 확장성을 확보했습니다.

**완료된 작업들:**
- **인터페이스 기반 설계**: `AuthServiceType` 및 `AuthDaoType` 인터페이스를 정의하여 각 레이어의 역할을 명확히 규정했습니다.
- **레이어 분리**:
    - **Service Layer**: 순수 비즈니스 로직만 처리합니다.
    - **DAO Layer**: 데이터베이스 CRUD 작업만 담당합니다.
- **의존성 주입(DI)**: `AuthFactory`를 구현하여 Service에 DAO 인스턴스를 주입, 결합도를 낮추고 테스트 용이성을 확보했습니다.
- **로직 통합**: `signin`, `signup`, `signout`, `password-reset` 등 여러 파일에 흩어져 있던 인증 관련 로직을 `AuthService` 클래스로 통합하여 중앙에서 관리합니다.
- **기존 파일 정리**: 불필요해진 개별 서비스 파일들을 제거하여 프로젝트 구조를 단순화했습니다.

**핵심 파일들:**
- `app/_entities/auth/dao/auth.dao.interface.ts` (신규)
- `app/_entities/auth/dao/auth.dao.ts` (신규)
- `app/_entities/auth/service/auth.service.interface.ts` (신규)
- `app/_entities/auth/service/auth.service.ts` (신규)
- `app/_entities/auth/auth.factory.ts` (신규)
- `app/_entities/auth/auth.service.ts` (통합 서비스 객체로 리팩토링)
- `app/api/auth/**/*route.ts` (모든 인증 API가 새로운 `authService`를 사용하도록 수정)

---

### 1번: 타입 정의 정리 및 일관성 확보 ✅

**왜 진행했는가?**
- `SignUpData` 타입에 불필요한 `role` 필드가 포함되어 타입 안전성이 저하되었습니다.
- 관리자/일반 회원가입 타입이 혼재되어 일관성이 부족했습니다.

**완료된 작업들:**
- `SignUpData`에서 `role` 필드 제거 및 `AdminSignUpData` 타입 분리.
- `AuthService`에서 `role`을 서버 사이드에서 강제하여 **권한 상승 취약점 원천 차단**.
- API 응답 타입 정확성 확보.

---

### 2번: 에러 처리 및 UX 개선 ✅

**왜 진행했는가?**
- `alert()` 사용으로 인한 사용자 경험 저하 및 피드백 방식의 비일관성.

**완료된 작업들:**
- `ToastHelper` 클래스를 생성하여 성공/에러/정보 등 모든 피드백을 일관된 UI(sonner)로 제공.
- 모든 인증 관련 폼(`SignInForm`, `SignUpForm`, `AdminSignUpForm` 등)에 `ToastHelper` 적용 완료.
- `Providers.tsx`에 `Toaster` 컴포넌트를 전역으로 추가.

---

### 3번: 사용자 경험(UX) 개선 ✅

**왜 진행했는가?**
- 관리자 회원가입 등 다단계 프로세스에서 사용자가 진행 상황을 파악하기 어려웠습니다.
- 로딩 상태 표시가 부족하여 중복 제출의 위험이 있었습니다.

**완료된 작업들:**
- **단계별 진행률 표시기**: `Progress` 컴포넌트를 사용하여 다단계 폼의 진행 상황을 시각적으로 표시.
- **로딩 상태**: `useMutation`의 `isPending` 상태를 활용하여 API 요청 중 버튼을 비활성화하고 "처리중..." 텍스트를 표시.
- **UI 개선**: 단계별 제목/설명, 이전 단계로 돌아가기 버튼 등을 추가하여 사용성 향상.

---

### 4번: 폼 검증 스키마 강화 ✅

**왜 진행했는가?**
- 입력 데이터의 유효성 검증이 부족하여 잘못된 데이터가 제출될 가능성이 있었습니다.

**완료된 작업들:**
- `zod`를 사용하여 모든 폼에 대한 강력한 유효성 검증 스키마(`*.form-model.ts`)를 정의.
- 비밀번호 복잡성(영대소문자, 숫자, 특수문자 포함), 인증번호 형식(6자리 숫자) 등 구체적인 규칙 적용.
- `react-hook-form`과 연동하여 실시간 인라인 에러 메시지 제공.

---

### 5번: 보안 강화된 비밀번호 재설정 시스템 구현 ✅

**왜 진행했는가?**
- 기존 임시 비밀번호 방식의 보안 취약점을 해결하고, 만료 시간이 있는 일회용 토큰 기반의 안전한 재설정 플로우 구축이 필요했음.

**완료된 작업들:**
- **Service/DAO 레이어 분리**: 비밀번호 재설정 로직을 새로운 아키텍처에 맞게 `AuthService`와 `AuthDao`로 분리하여 구현.
- **보안 강화**:
    - 임시 비밀번호 대신 만료 시간(15분)이 있는 **일회용 재설정 토큰** 사용.
    - 토큰을 DB에 저장 시 **bcrypt로 해싱**하여 안전하게 보관 (`PasswordResetToken` 테이블).
    - 이메일 존재 여부 추측 공격을 막기 위해, 존재하지 않는 이메일 요청에도 성공으로 응답.
- **API 및 UI**: 재설정 토큰 발급(`verify-email`) 및 비밀번호 변경(`reset-password`) API와 관련 UI 전체 구현 완료.

---

### 6번: 관리자 회원가입 시스템 구현 ✅

**왜 진행했는가?**
- 안전하고 통제된 방식으로 관리자 계정을 생성할 프로세스가 필요했습니다.

**완료된 작업들:**
- **2단계 인증 도입**: 운영 환경에서는 슈퍼 관리자 이메일로 인증 코드를 발송하고, 해당 코드를 검증해야만 관리자 계정이 생성됩니다.
- **환경별 분리**: 개발 환경에서는 `private.config.json`의 `mail.enable_in_development` 설정에 따라 인증 절차를 생략하고 즉시 계정을 생성할 수 있어 개발 편의성을 높였습니다.
- **전용 API 및 UI**: `POST /api/auth/admin/signup` API와 다단계 UI를 구현했습니다.

---

### 7번: 보안 강화 (로그인) ✅

**왜 진행했는가?**
- 로그인 실패 시 구체적인 에러 메시지("User not found" 등)는 이메일 존재 여부를 노출시켜 보안에 취약했습니다.

**완료된 작업들:**
- `AuthService.signIn` 로직을 개선하여, 이메일이 존재하지 않거나 비밀번호가 틀린 경우 모두 **"이메일 또는 비밀번호가 올바르지 않습니다."** 라는 통일된 에러 메시지를 반환하도록 수정했습니다.

---

## 🚨 남은 과제들

### 8번: 보안 강화 (인증)

**왜 진행해야 하는가?**
- **무차별 대입 공격(Brute-force attack) 방지**: 현재 인증번호 재시도 횟수에 제한이 없어, 공격자가 무한정 시도하여 코드를 맞출 수 있는 위험이 있습니다.
- **사용자 경험 개선**: 인증번호의 만료 시간을 사용자에게 명확히 알려주지 않아, 만료 후에도 계속 시도하며 혼란을 겪을 수 있습니다.
- **시스템 안정성 확보**: 단시간에 과도한 인증 요청이 발생할 경우 시스템에 부하를 줄 수 있습니다.

**구체적인 작업들:**

1.  **인증 시도 횟수 제한 (Rate Limiting)**
    -   `[ ]` **DB 모델링**: `AdminVerifyHistory` 테이블에 `attempt_count` (시도 횟수) 컬럼을 추가하여 시도 횟수를 기록합니다.
    -   `[ ]` **Service 로직**: 인증 코드 검증(`verifyAdminCode`) 시, 실패할 때마다 `attempt_count`를 1씩 증가시킵니다.
    -   `[ ]` **시도 횟수 확인**: 인증 요청 시 `attempt_count`가 특정 횟수(예: 5회)를 초과했는지 확인하고, 초과 시 에러를 반환합니다.

2.  **계정/IP 기반 임시 잠금**
    -   `[ ]` **DB 모델링**: `AdminVerifyHistory` 테이블에 `locked_until` (잠금 만료 시간) 컬럼을 추가합니다.
    -   `[ ]` **Service 로직**: 시도 횟수 초과 시 `locked_until`을 현재 시간으로부터 일정 시간(예: 10분) 후로 설정합니다.
    -   `[ ]` **잠금 확인**: 인증 요청 시 `locked_until` 시간이 현재 시간보다 미래인지 확인하고, 잠금 상태일 경우 "과도한 시도로 인해 계정이 잠겼습니다. 10분 후에 다시 시도해주세요."와 같은 명확한 메시지를 반환합니다.

3.  **인증번호 만료 시간 관리 및 안내**
    -   `[ ]` **DB 모델링**: `AdminVerifyHistory` 테이블에 `expires_at` (만료 시간) 컬럼을 추가합니다.
    -   `[ ]` **Service 로직**: 인증 코드 생성 시 `expires_at`을 현재 시간으로부터 10분 후로 설정합니다.
    -   `[ ]` **만료 확인**: 코드 검증 시 `expires_at`이 지났는지 확인하고, 만료 시 에러를 반환합니다.
    -   `[ ]` **UI 개선**: 프론트엔드(`VerificationStep.tsx`)에 만료까지 남은 시간을 표시하는 타이머를 구현합니다. (예: "남은 시간: 09:59")
    -   `[ ]` **UI 개선**: 시간이 만료되면 "인증 시간이 만료되었습니다. 다시 요청해주세요." 메시지를 표시하고, 재요청 버튼을 활성화합니다.

4.  **보안 로깅 강화**
    -   `[ ]` **Logger 연동**: 인증 실패, 시도 횟수 초과, 계정 잠금 등 주요 보안 이벤트를 `Logger.security()`를 사용하여 상세히 기록하여 추적 및 분석이 용이하도록 합니다.

---

### 9번: 게스트북 시스템 구현

**왜 진행해야 하는가?**
- 블로그 방문자와의 소통 및 사용자 참여 유도를 위한 핵심 기능입니다.

**구체적인 작업들:**
- [ ] 게스트북 관련 페이지, API, 데이터베이스 모델 전체 구현

---

## 📈 진행 상황 요약

| 과제 번호 | 과제명                        | 상태         | 완료율 | 우선순위 |
| --------- | ----------------------------- | ------------ | ------ | -------- |
| ★         | **아키텍처 리팩토링**         | ✅ 완료      | 100%   | **최고** |
| 1         | 타입 정의 및 일관성 확보      | ✅ 완료      | 100%   | 높음     |
| 2         | 에러 처리 및 UX 개선          | ✅ 완료      | 100%   | 높음     |
| 3         | 사용자 경험(UX) 개선          | ✅ 완료      | 100%   | 중간     |
| 4         | 폼 검증 스키마 강화           | ✅ 완료      | 100%   | 높음     |
| 5         | 비밀번호 재설정 시스템 구현   | ✅ 완료      | 100%   | 높음     |
| 6         | 관리자 회원가입 시스템 구현   | ✅ 완료      | 100%   | 높음     |
| 7         | 보안 강화 (로그인)            | ✅ 완료      | 100%   | 중간     |
| 8         | 보안 강화 (인증)              | 🔄 진행 예정 | 0%     | 낮음     |
| 9         | 게스트북 시스템 구현          | 🔄 진행 예정 | 0%     | 높음     |

---

## 🚀 다음 단계

**Auth 도메인의 핵심 기능 구현과 아키텍처 리팩토링이 모두 완료**되었습니다. 시스템의 안정성과 확장성이 크게 향상된 상태입니다.

**남은 과제 (우선순위별):**
1.  **9번: 게스트북 시스템 구현** - 새로운 핵심 기능
2.  **8번: 보안 강화 (인증)** - 기존 시스템 보완

이제 새로운 기능인 게스트북 시스템 구현을 시작할 준비가 되었습니다.