# 인증 및 세션 시스템 분석 결과 (v2)

최근 `Auth` 도메인에 대한 대대적인 리팩토링과 보안 강화 작업이 완료되었습니다. 본 문서는 최신 아키텍처를 반영하여 시스템을 재분석한 결과입니다.

전반적으로 Spring Boot 스타일의 **인터페이스 기반 Service/DAO 레이어 분리**가 성공적으로 적용되었고, 치명적인 보안 취약점들이 해결되었습니다. `HttpOnly` 쿠키를 사용하는 등 기존의 좋은 관행은 그대로 유지되고 있습니다.

### 1. 개선된 아키텍처 요약

1.  **프론트엔드 (Client)**:
    *   `app/(auth)`: 로그인/회원가입 UI.
    *   `@/_entities/auth/hooks`: React Query 훅을 통해 API와 통신.
    *   `@/_entities/auth/auth.store.ts`: Zustand(persist)를 사용해 클라이언트 인증 상태 관리.
    *   `@/_entities/auth/hooks/useSession.ts`: 앱 로드 시 서버에 세션 유효성 검증.

2.  **백엔드 (API Route Handlers)**:
    *   `app/api/auth/.../route.ts`: 각 API 엔드포인트는 `authService`를 호출하는 역할만 수행.
    *   `signIn`: 로그인 성공 시 `access_token`, `refresh_token`을 `HttpOnly` 쿠키에 설정.
    *   `session`: `useSession` 훅에서 호출되어 쿠키의 토큰을 검증하고 세션 갱신.

3.  **서비스 로직 (Service Layer)**:
    *   **`AuthService`**: `AuthFactory`를 통해 `AuthDao`를 의존성 주입(DI)받아 비즈니스 로직만 처리.
    *   **`signUp`**: 이메일 중복 확인 후, `AuthDao`를 통해 `role: 'USER'`로 고정하여 사용자 생성.
    *   **`signUpAdmin`**: 2단계 인증을 거쳐 `role: 'ADMIN'`으로 관리자 생성.
    *   **`signIn`**: `AuthDao`로 사용자 조회 및 비밀번호 검증, 성공 시 JWT 토큰 생성.
    *   **`requestPasswordReset` / `resetPassword`**: **보안이 강화된 비밀번호 재설정 로직**. 임시 토큰을 별도 테이블(`PasswordResetToken`)에 해시하여 저장하고, 만료 시간(15분) 및 1회용 사용 규칙을 적용.

4.  **데이터 접근 (DAO Layer)**:
    *   **`AuthDao`**: `Prisma`를 직접 호출하여 DB CRUD 작업만 수행. Service 레이어로부터 완전히 분리.

5.  **세션 관리**:
    *   Access/Refresh Token 기반의 표준 JWT 세션 관리.
    *   `middleware.ts`는 여전히 비활성화 상태이며, 페이지 접근 제어는 클라이언트 사이드(`AdminLayoutProvider`)에서 수행.

---

### 2. 해결된 취약점 및 개선 사항

#### ✅ **(해결됨)** 중요도: 높음 (High) - 권한 상승 취약점

*   **문제점**: 과거 `signUp` API가 클라이언트에서 보낸 `role` 값을 검증 없이 DB에 저장하여, 요청 조작 시 관리자 계정을 생성할 수 있었습니다.
*   **개선 조치**:
    1.  **일반 회원가입**: `AuthService` -> `AuthDao.createUser` 호출 시 `role`을 `'USER'`로 강제하여 일반 사용자가 관리자 권한을 획득할 수 있는 경로를 원천 차단했습니다.
    2.  **관리자 회원가입**: 별도의 `POST /api/auth/admin/signup` API를 신설했습니다. 운영 환경에서는 슈퍼 관리자 이메일로 인증 코드를 발송하고, 해당 코드를 검증해야만 관리자 계정이 생성되는 2단계 인증(Two-factor authentication) 프로세스를 도입하여 보안을 대폭 강화했습니다.

#### ✅ **(해결됨)** 중요도: 낮음 (Low) - 에러 메시지 상세 노출

*   **문제점**: 로그인 실패 시 "User not found"와 같이 구체적인 실패 원인을 반환하여, 특정 이메일의 가입 여부를 추측할 수 있는 단서(Username Enumeration)를 제공했습니다.
*   **개선 조치**: `AuthService.signIn` 로직을 수정하여, 이제 이메일이 존재하지 않거나 비밀번호가 틀린 경우 모두 **"이메일 또는 비밀번호가 올바르지 않습니다."** 라는 통일된 메시지를 반환합니다.

---

### 3. 현재 시스템의 주요 강점

*   **아키텍처 개선**: Service/DAO 레이어 분리와 의존성 주입 패턴 적용으로 코드의 유지보수성, 테스트 용이성, 확장성이 크게 향상되었습니다.
*   **비밀번호 재설정 보안 강화**: 기존의 임시 비밀번호 방식에서 벗어나, 만료 시간이 있는 일회용 토큰을 별도 테이블에 안전하게 해시하여 저장하는 방식으로 변경하여 재전송 공격(Replay Attack) 등의 위협을 방어합니다.
*   **관리자 생성 프로세스 강화**: 2단계 인증 기반의 관리자 회원가입 프로세스는 내부 관계자만 관리자 계정을 생성할 수 있도록 보장합니다.

---

### 4. 남은 개선 권장 사항

#### 🟡 중요도: 중간 (Medium)

**1. 서버 사이드 권한 검증을 위한 미들웨어 부재**

*   **위치**: `middleware.ts`
*   **현황**: `middleware.ts`가 비활성화되어 있어 서버 레벨의 경로 접근 제어가 이루어지지 않고 있습니다. 현재 `AdminLayoutProvider`가 클라이언트 사이드에서 관리자가 아닌 사용자를 리다이렉트하지만, 이는 브라우저에서만 유효합니다.
*   **잠재적 위험**: 악의적인 사용자가 API 요청 도구를 사용하여 관리자 전용 API 엔드포인트(`예: /api/admin/...`)를 직접 호출할 경우, 데이터가 노출되거나 비인가 작업이 수행될 수 있습니다.
*   **개선 방안**:
    *   **`middleware.ts` 활성화**: `matcher`를 사용해 `/admin` 및 `/api/admin` 등 보호가 필요한 경로를 지정합니다.
    *   **토큰 검증 및 역할 확인**: 미들웨어에서 `access_token`을 검증하고, 토큰의 `role`이 `'ADMIN'`인지 확인하여 비인가 접근을 서버 단에서 차단해야 합니다.

**2. 로그아웃 시 토큰 완전 무효화 미흡**

*   **위치**: `AuthService.signOut`
*   **현황**: 로그아웃 시 DB에서 Refresh Token만 제거합니다. 만약 Access Token이 탈취되었고 아직 만료 전이라면, 해당 토큰은 로그아웃 이후에도 계속 유효합니다.
*   **개선 방안**:
    *   **Blacklist 구현**: 로그아웃된 토큰의 `jti`(JWT ID)를 짧은 만료 시간을 가진 Redis나 다른 캐시 저장소에 블랙리스트로 등록합니다. 미들웨어나 각 API에서 토큰 검증 시 이 블랙리스트를 확인하는 절차를 추가합니다.

---

### 5. 총평

**치명적인 권한 상승 취약점이 해결**되었고, **아키텍처가 대폭 개선**되어 시스템의 전반적인 보안 수준과 안정성이 크게 향상되었습니다.

가장 시급했던 문제들이 해결된 지금, 다음 단계로 **`middleware.ts`를 활성화하여 서버 사이드 접근 제어를 구현**하는 것이 가장 중요합니다. 이를 통해 클라이언트 사이드 리다이렉션을 우회하는 직접적인 API 공격을 효과적으로 방어할 수 있을 것입니다.

---

### 인증 시스템 개선 To-Do 리스트

-   [x] **(완료)** `AuthService.signUp`에서 `role` 값을 항상 'USER'로 강제하여 관리자 계정 생성 취약점 해결
-   [ ] **(진행 필요)** `middleware.ts`를 활성화하여 경로 기반 접근 제어(예: `/admin` 경로 보호) 및 세션 검증 로직 구현
-   [ ] **(진행 필요)** 로그아웃 시 Access Token을 무효화하기 위한 블랙리스트 메커니즘 구현
-   [x] **(완료)** 로그인 실패 시 "이메일 또는 비밀번호가 올바르지 않습니다."와 같이 통일된 에러 메시지를 반환하도록 수정
-   [x] **(완료)** ✨ **보안 강화된 비밀번호 재설정 시스템**으로 리팩토링 완료
    -   별도 토큰 테이블(`PasswordResetToken`) 사용
    -   해시된 토큰 저장, 15분 만료 시간, 1회용 토큰 규칙 적용
    -   Service/DAO 레이어 분리 및 인터페이스 기반 설계 적용
