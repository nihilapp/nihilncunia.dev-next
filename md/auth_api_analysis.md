# Auth API 심층 분석 및 개선 제안

이 문서는 현재 인증(Auth) API의 구조를 분석하고, 기능적 보완점과 보안 강화 방안을 제시합니다.

---

## 1. 현재 API 엔드포인트 현황

-   `POST /api/auth/signup`: 일반 사용자 회원가입
-   `POST /api/auth/signin`: 사용자 로그인
-   `POST /api/auth/signout`: 사용자 로그아웃
-   `GET /api/auth/session`: 현재 사용자 세션 정보 확인 및 갱신
-   `POST /api/auth/admin/signup`: 관리자 회원가입 (2단계 인증 포함)
-   `POST /api/auth/verify-email`: 비밀번호 재설정을 위한 임시 비밀번호 발송
-   `POST /api/auth/reset-password`: 임시 비밀번호를 사용하여 새 비밀번호로 재설정

---

## 2. 분석 및 평가

### 2.1. 잘된 점 (Strengths)

-   **Service/DAO 아키텍처 적용**: 비즈니스 로직과 데이터 접근 로직이 명확히 분리되어 테스트와 유지보수가 용이합니다.
-   **역할 기반 회원가입 분리**: 일반 사용자(`signup`)와 관리자(`admin/signup`)의 회원가입 로직이 분리되어 있어 보안적으로 안전합니다.
-   **보안 강화된 관리자 생성**: 운영 환경에서 2단계 인증을 통해 관리자 계정 생성을 보호하는 메커니즘은 매우 훌륭합니다.
-   **세션 관리**: `session` 엔드포인트에서 Access Token 만료 시 Refresh Token을 사용하여 자동으로 세션을 갱신하는 로직이 구현되어 있습니다.
-   **일관된 응답 형식**: `successResponse`, `errorResponse` 헬퍼를 사용하여 API 응답 구조가 통일되어 있습니다.
-   **상세한 로깅**: `Logger`를 통해 각 API의 주요 단계와 에러 상황을 기록하고 있어 디버깅 및 추적이 용이합니다.

### 2.2. 개선 및 보완 필요 사항

#### **A. 비밀번호 재설정 플로우 (보안 취약점 존재)**

-   **현재 방식**: 임시 비밀번호를 이메일로 발송하고, 사용자는 그 임시 비밀번호를 사용하여 새 비밀번호로 변경합니다.
-   **문제점**:
    1.  **임시 비밀번호 탈취 위험**: 이메일 계정이 탈취되었을 경우, 공격자가 임시 비밀번호를 확인하여 계정을 장악할 수 있습니다.
    2.  **중간자 공격 가능성**: 임시 비밀번호가 평문으로 전송될 경우, 네트워크 스니핑 등으로 유출될 위험이 있습니다.
    3.  **사용자 불편**: 사용자가 임시 비밀번호를 직접 복사하여 붙여넣어야 하는 번거로움이 있습니다.
-   **개선 제안**:
    -   **일회용 토큰 기반으로 변경**:
        1.  `verify-email` 요청 시, 임시 비밀번호 대신 **만료 시간(예: 15분)이 있는 일회용 비밀번호 재설정 토큰**을 생성합니다.
        2.  이 토큰을 DB(`PasswordResetToken` 테이블)에 **해시하여 저장**합니다.
        3.  사용자에게는 이 토큰이 포함된 비밀번호 재설정 링크(예: `/auth/reset-password?token=...`)를 이메일로 발송합니다.
        4.  사용자가 링크를 클릭하면, `reset-password` 페이지에서 토큰의 유효성을 검증하고 새 비밀번호를 입력받습니다.
        5.  `reset-password` API는 토큰과 새 비밀번호를 받아, DB에 저장된 해시된 토큰과 비교하여 유효성을 검증한 후 비밀번호를 변경하고 토큰을 즉시 만료시킵니다.
    -   **기대 효과**:
        -   이메일이 탈취되어도 토큰 자체로는 계정 접근이 불가능하여 보안이 크게 향상됩니다.
        -   사용자는 링크 클릭 한 번으로 비밀번호 변경 페이지에 도달하여 UX가 개선됩니다.

#### **B. API 명세 및 역할 불분명**

-   **`POST /api/auth/verify-email`**:
    -   **현재 역할**: "비밀번호 재설정을 위한 임시 비밀번호 발송"
    -   **문제점**: API 경로(`verify-email`)와 실제 기능(비밀번호 재설정 시작)이 직관적으로 연결되지 않습니다. "이메일 주소 유효성 검증"이라는 다른 기능으로 오해될 소지가 있습니다.
    -   **개선 제안**:
        -   API 경로를 **`POST /api/auth/password/request-reset`** 또는 **`POST /api/auth/password/forgot`** 과 같이 명확하게 변경하는 것을 권장합니다.
        -   이렇게 하면 "비밀번호 재설정을 요청"하는 API임이 명확해집니다.

-   **`POST /api/auth/reset-password`**:
    -   **현재 역할**: "임시 비밀번호와 새 비밀번호로 재설정"
    -   **개선 제안**:
        -   위의 'A' 제안에 따라 토큰 기반으로 변경될 경우, API 경로는 그대로 사용하되 역할은 "재설정 토큰과 새 비밀번호로 재설정"으로 변경됩니다. 이는 현재의 경로와 더 잘 부합합니다.

#### **C. 인증 관련 보안 강화 부재**

-   **`과제진행현황.md`의 8번 항목**: "보안 강화 (인증)"에서 언급된 내용들이 아직 API에 반영되지 않았습니다.
-   **문제점**:
    1.  **무차별 대입 공격(Brute-force)**: `signin`, `reset-password`, `admin/signup`의 인증 코드 확인 등에서 단시간에 여러 번의 요청을 시도하는 공격에 취약합니다.
    2.  **계정 잠금 부재**: 반복된 로그인 실패 시 계정을 일시적으로 잠그는 기능이 없습니다.
-   **개선 제안**:
    -   **Rate Limiting 도입**: `upstash/ratelimit` 또는 유사한 라이브러리를 사용하여 IP 주소 또는 사용자 ID 기반으로 요청 횟수를 제한해야 합니다.
        -   **적용 대상**: `signin`, `reset-password`, `verify-email`, `admin/signup`
    -   **계정 잠금 정책 구현**:
        -   일정 횟수(예: 5회) 이상 로그인 또는 비밀번호 재설정 시도 실패 시, 해당 계정을 특정 시간(예: 10분) 동안 잠그는 로직을 `AuthService`에 추가해야 합니다.
        -   이를 위해 `User` 모델에 `failed_attempts` (실패 횟수), `locked_until` (잠금 만료 시간)과 같은 필드 추가를 고려할 수 있습니다.

#### **D. 세션 관리의 잠재적 개선점**

-   **`signout` 로직**: 현재 로그아웃 시 서버 측에서 특별한 처리를 하지 않고 클라이언트의 쿠키만 삭제합니다.
-   **문제점**: 만약 Access Token이 탈취된 상태라면, 클라이언트가 로그아웃하더라도 공격자는 해당 토큰의 만료 시점까지 계속 사용할 수 있습니다.
-   **개선 제안 (선택적, 고도화)**:
    -   **Denylist(거부 목록) 구현**: 로그아웃 시 해당 Access Token의 `jti`(JWT ID)를 Redis나 DB에 짧은 만료 시간(토큰의 남은 유효시간)과 함께 저장합니다.
    -   `session` 엔드포인트나 다른 보호된 API 요청이 들어올 때마다, 해당 토큰이 Denylist에 있는지 확인하는 절차를 추가합니다.
    -   **기대 효과**: 즉각적인 토큰 무효화가 가능해져 보안성이 향상됩니다. (단, 모든 요청에 DB 조회가 추가되므로 성능 트레이드오프를 고려해야 합니다.)

---

## 3. 종합 결론 및 권장 다음 단계

현재 `auth` API는 견고한 아키텍처 위에 구축되어 있으나, 몇 가지 중요한 기능 및 보안 강화가 필요합니다.

**우선순위 높은 권장 사항:**

1.  **비밀번호 재설정 플로우 개선 (A)**: 현재의 임시 비밀번호 방식은 보안에 취약하므로, 최우선으로 **일회용 토큰 기반**으로 변경해야 합니다.
2.  **API 명세 명확화 (B)**: 1번을 진행하면서 `verify-email` API의 경로를 `password/request-reset` 등으로 변경하여 역할과 경로를 일치시키는 리팩토링을 수행합니다.
3.  **인증 보안 강화 (C)**: Rate Limiting을 도입하여 무차별 대입 공격을 방지하는 것이 시급합니다.

**중/장기적 권장 사항:**

4.  **세션 관리 고도화 (D)**: Denylist를 구현하여 로그아웃된 토큰을 즉시 무효화하는 방안을 검토합니다.

**결론적으로, `otp` 라우트를 제거한 것은 좋은 결정이었으며, 이제 분산된 인증 관련 API들의 역할과 보안을 강화하는 데 집중해야 합니다.**
